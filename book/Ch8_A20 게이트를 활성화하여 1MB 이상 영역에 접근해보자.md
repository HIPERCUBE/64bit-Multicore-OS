# A20 게이트를 활성화하여 1MB 이상 영역에 접근해보자

## IA-32e 모드 커널과 메모리 맵
이번장에서 진행할 내용
 - **IA-32e** 모드 커널을 실행하기 위한 준비 작업으로 PC에 설치된 메모리가 64MB 이상인지 검사
 - **IA-32e** 모드 커널이 위치할 영역을 모두 0으로 초기화
 - 부팅과정을 완료하고 나서 1MB 이상의 메모리에 정상적으로 접근되는지 확인

1MB 이상의 메모리에 접근해야 하는 이유
> 부트로더에 의해 커널 이미지가 메모리에 로딩되는 어드레스는 **0x10000**이다.
> 만약 1MB 이하의 어드레스중에서 비디오 메모리가 위치하는 **0xA0000** 이하를 커널 공간으로 사용한다고 가정하면, 보호 모드 커널과 IA-32e 모드 커널의 최대 크기는 (0xA0000 - 0x10000)이 되어 576KB 정도가 된다.
> 커널 이미지외에도 초기화되지 않은 영역(.bss 섹션)의 공간도 필요하다.
> 추후에 멀티태스킹과 파일 시스템과 같은 기능이 추가되어 커널이 커진다면 576KB로는 부족하다.

MINT64 OS는 이러한 문제를 해결하기 위해 커널 이미지를 모두 0x10000 어드레스에 복사하되, 덩치가 큰 **IA-32e** 모드 커널은 2MB의 어드레스로 복사하여 2MB ~ 6MB의 영역을 별도로 할당했다.
따라서 IA-32e 모드의 커널영역은 모드 섹션을 포함하여 총 **4MB**의 크기가 된다.
아래 그림은 MINT 64 OS의 메모리 맵이다.

![](https://github.com/HIPERCUBE/64bit-Multicore-OS/blob/master/book/img/Ch8_img1.jpg)

왜 IA-32e 모드 커널이 위치할 영역을 0으로 초기화 할까?
커널 이미지로 덮어써버리기때문에 초기화할 필요가 없지 않을까라고 생각했다.
책에서는 이렇게 말한다.
> 미리 초기화 하는 이유는 IA-32e 커널 이미지가 초기화되지 않은 영역을 포함하고 있지 않기 때문이다.
> 비록 커널은 초기화되지 않은 영역을 사용하지만, 커널 이미지에는 초기화 되지 않은 영역이 제외되어 있다.
> 따라서 커널 이미지를 옮길 때도 이 영역은 해당되지 않으며, 이미지를 옮길 영역을 미리 0으로 초기화 하지 않는다면 어떤 임의의 값이 들어 있을 것이다.
> 이런 상태에서 IA-32e 모드 커널이 실행되면 0으로 참조되어야 할 변수들이 0이 아닌 값으로 설정되어, 루프를 빠져 나오지 못한다든지 잘못된 조건문이 실행된다든지 하는 문제가 발생할 가능성이 있다.
> 0으로 초기화 하는 이유는 미연을 방지하기 위해서이다.

## IA-32e 모드 커널을 위한 메모리 초기화


## 1MB 어드레스와 A20 게이트


## A20 게이트 적용과 메모리 크기 검사
